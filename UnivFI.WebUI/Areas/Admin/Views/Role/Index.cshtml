@using UnivFI.WebUI.Areas.Admin.ViewModels.Role
@model RoleListViewModel

@{
    ViewData["Title"] = "역할 관리";
}

<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">역할 관리</h1>
    <div class="h-0.5 bg-gray-200 w-full mb-6"></div>

    <!-- 검색 폼 -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <a asp-action="Create" asp-route-returnPage="@Model.CurrentPage" asp-route-returnPageSize="@Model.PageSize"
                asp-route-returnSearchTerm="@Model.SearchTerm" asp-route-returnSearchFields="@Model.SearchFields"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i> 새 역할 추가
            </a>
        </div>
        <div class="w-full md:w-auto">
            <form asp-action="Index" method="get" class="flex" id="searchForm">
                <div class="flex">
                    <div class="relative">
                        <button id="searchDropdown" type="button"
                            class="px-4 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors rounded-l flex items-center">
                            검색 필드
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="searchDropdownMenu"
                            class="absolute left-0 mt-1 w-48 bg-white rounded-md shadow-lg hidden z-10 border">
                            <div class="py-1">
                                <div class="px-4 py-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="checkRoleName" class="search-field-checkbox mr-2">
                                        <label for="checkRoleName">역할명</label>
                                    </div>
                                </div>
                                <div class="px-4 py-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="checkRoleComment" class="search-field-checkbox mr-2">
                                        <label for="checkRoleComment">설명</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="searchFields" id="searchFieldsInput" value="@Model.SearchFields">
                    <input type="text" name="searchTerm" value="@Model.SearchTerm"
                        class="px-4 py-2 border focus:ring-blue-500 focus:border-blue-500 flex-1 min-w-0"
                        placeholder="검색어를 입력하세요">
                    <input type="hidden" name="page" id="currentPage" value="@Model.CurrentPage">
                    <input type="hidden" name="pageSize" value="@Model.PageSize">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search"></i> 검색
                    </button>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <a asp-action="Index"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-r hover:bg-gray-400 transition-colors">
                            <i class="fas fa-times"></i> 초기화
                        </a>
                    }
                </div>
            </form>
        </div>
    </div>

    <!-- 역할 목록 테이블 -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">역할명
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">설명
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">액션
                        </th>
                    </tr>
                </thead>
                <tbody id="roleTableBody" class="bg-white divide-y divide-gray-200">
                    @foreach (var role in Model.Roles)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@role.Id</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@role.RoleName</td>
                            <td class="px-6 py-4 text-sm text-gray-500">@role.RoleComment</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a asp-action="Edit" asp-route-id="@role.Id" asp-route-returnPage="@Model.CurrentPage"
                                        asp-route-returnPageSize="@Model.PageSize"
                                        asp-route-returnSearchTerm="@Model.SearchTerm"
                                        asp-route-returnSearchFields="@Model.SearchFields"
                                        class="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600 transition-colors">
                                        <i class="fas fa-edit mr-1"></i> 수정
                                    </a>
                                    <a asp-action="Detail" asp-route-id="@role.Id" asp-route-returnPage="@Model.CurrentPage"
                                        asp-route-returnPageSize="@Model.PageSize"
                                        asp-route-returnSearchTerm="@Model.SearchTerm"
                                        asp-route-returnSearchFields="@Model.SearchFields"
                                        class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                                        <i class="fas fa-eye mr-1"></i> 상세
                                    </a>
                                    <button type="button"
                                        class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
                                        onclick="openDeleteModal(@role.Id, '@role.RoleName', '@Model.CurrentPage', '@Model.PageSize', '@Model.SearchTerm', '@Model.SearchFields')">
                                        <i class="fas fa-trash mr-1"></i> 삭제
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @{
            // 페이징 모델 생성
            var pagingModel = new UnivFI.WebUI.Areas.Admin.ViewModels.PaginationViewModel
            {
                CurrentPage = Model.CurrentPage,
                TotalPages = Model.TotalPages,
                PageSize = Model.PageSize,
                TotalItems = Model.TotalItems,
                ActionName = "Index",
                ControllerName = "Role",
                AreaName = AdminAreaConfiguration.AreaName
            };

            // RouteData에 검색 매개변수와 페이지 크기 추가
            pagingModel.RouteData.Add("pageSize", Model.PageSize.ToString());

            if (!string.IsNullOrEmpty(Model.SearchTerm))
            {
                pagingModel.RouteData.Add("searchTerm", Model.SearchTerm);
            }

            if (!string.IsNullOrEmpty(Model.SearchFields))
            {
                pagingModel.RouteData.Add("searchFields", Model.SearchFields);
            }
        }
        <div id="paginationContainer" class="p-6">
            <!-- 페이징 컴포넌트 -->
            <partial name="_Pagination" model="@pagingModel" />
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="mb-4">
            <h3 class="text-lg font-semibold" id="deleteModalTitle">역할 삭제 확인</h3>
        </div>
        <div class="mb-6">
            <p id="deleteModalMessage">역할을 삭제하시겠습니까?</p>
            <p class="text-red-600 mt-2">이 작업은 되돌릴 수 없습니다.</p>
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors"
                onclick="closeDeleteModal()">
                취소
            </button>
            <form id="deleteForm" method="post">
                <input type="hidden" id="deletePage" name="returnPage" value="" />
                <input type="hidden" id="deletePageSize" name="returnPageSize" value="" />
                <input type="hidden" id="deleteTerm" name="returnSearchTerm" value="" />
                <input type="hidden" id="deleteFields" name="returnSearchFields" value="" />
                <button type="submit"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                    삭제
                </button>
            </form>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-5 rounded-lg shadow-lg flex items-center">
        <div class="loader mr-3">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
        </div>
        <div class="text-gray-700 text-lg">데이터를 불러오는 중...</div>
    </div>
</div>

<!-- 에러 모달 -->
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <div class="mb-4">
            <h3 class="text-xl font-semibold text-red-600">오류 발생</h3>
        </div>
        <div class="mb-6">
            <p id="errorMessage" class="text-gray-700">데이터를 불러오는 도중 오류가 발생했습니다.</p>
        </div>
        <div class="flex justify-end">
            <button type="button" onclick="closeErrorModal()"
                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                닫기
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 페이징 기능 초기화
            PaginationUtils.init({
                controller: 'Role',
                loadPageCallback: loadRolePage
            });

            // 검색 기능 초기화
            SearchUtils.init({
                formSelector: '#searchForm',
                checkboxSelector: '.search-field-checkbox',
                fieldsInputSelector: '#searchFieldsInput',
                defaultFields: 'RoleName,RoleComment',
                searchCallback: searchRoles
            });

            // 역할 페이지 로드 함수
            function loadRolePage(page) {
                const searchTerm = $('input[name="searchTerm"]').val();
                const searchFields = $('#searchFieldsInput').val();
                const pageSize = $('input[name="pageSize"]').val();

                PaginationUtils.loadPage({
                    url: '@Url.Action("Index", "Role", new { area = "Admin" })',
                    page: page,
                    pageSize: pageSize,
                    searchTerm: searchTerm,
                    searchFields: searchFields,
                    tableBodySelector: '#roleTableBody',
                    paginationSelector: '#paginationContainer'
                });
            }

            // 역할 검색 함수
            function searchRoles(searchTerm) {
                // 검색어가 변경되면 페이지 번호 재설정
                $('#currentPage').val(1);
                loadRolePage(1);
            }

            // ESC 키를 눌렀을 때 모달 닫기
            $(document).keydown(function (e) {
                if (e.key === "Escape" && !$('#deleteModal').hasClass('hidden')) {
                    closeDeleteModal();
                }
                if (e.key === "Escape" && !$('#errorModal').hasClass('hidden')) {
                    closeErrorModal();
                }
            });
        });

        // 삭제 모달 열기
        function openDeleteModal(id, name, page, pageSize, searchTerm, searchFields) {
            // 모달 내용 설정
            $('#deleteModalTitle').text('역할 삭제 확인');
            $('#deleteModalMessage').text(`"${name}" 역할을 삭제하시겠습니까?`);

            // 삭제 폼 설정
            $('#deleteForm').attr('action', `/Admin/Role/Delete/${id}`);
            $('#deletePage').val(page);
            $('#deletePageSize').val(pageSize);
            $('#deleteTerm').val(searchTerm);
            $('#deleteFields').val(searchFields);

            // 모달 표시
            $('#deleteModal').removeClass('hidden');
        }

        // 삭제 모달 닫기
        function closeDeleteModal() {
            // 모달 숨기기
            $('#deleteModal').addClass('hidden');
        }

        // 오류 모달 표시 함수
        function showErrorModal(message) {
            ModalUtils.showErrorModal(message, 'errorModal');
        }

        // 오류 모달 닫기
        function closeErrorModal() {
            ModalUtils.closeModal('errorModal');
        }
    </script>
}
