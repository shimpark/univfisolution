@using UnivFI.WebUI.Areas.Admin.ViewModels.MenuRole
@model IEnumerable<MenuRoleViewModel>
@{
    ViewData["Title"] = "메뉴 역할 관리";
}

<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">메뉴 역할 관리: @ViewBag.MenuTitle</h1>
    <div class="h-0.5 bg-gray-200 w-full mb-6"></div>

    <div class="flex flex-wrap gap-2 mb-6">
        <a asp-action="Assign" asp-route-preSelectedMenuId="@ViewBag.MenuId"
            asp-route-returnPage="@ViewBag.ReturnPage"
            asp-route-returnPageSize="@ViewBag.ReturnPageSize"
            asp-route-returnSearchTerm="@ViewBag.ReturnSearchTerm"
            asp-route-returnSearchFields="@ViewBag.ReturnSearchFields"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
            <i class="fas fa-plus-circle mr-2"></i> 새 역할 할당
        </a>
        <a asp-controller="Menu" asp-action="Detail" asp-route-id="@ViewBag.MenuId"
            class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> 메뉴 상세로 돌아가기
        </a>
        <a asp-action="Index"
            asp-route-page="@ViewBag.ReturnPage"
            asp-route-pageSize="@ViewBag.ReturnPageSize"
            asp-route-searchTerm="@ViewBag.ReturnSearchTerm"
            asp-route-searchFields="@ViewBag.ReturnSearchFields"
            class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
            <i class="fas fa-list mr-2"></i> 메뉴 역할 목록으로 돌아가기
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-blue-500 text-white px-6 py-4">
            <h2 class="font-semibold text-lg">할당된 역할 목록</h2>
        </div>
        <div class="p-6">
            @if (Model != null && Model.Any())
            {
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    메뉴 ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    역할 ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    메뉴 키</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    메뉴 제목</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    역할 이름</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    작업</th>
                            </tr>
                        </thead>
                        <tbody id="menuRoleTableBody" class="bg-white divide-y divide-gray-200">
                            @foreach (var menuRole in Model)
                            {
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">@menuRole.MenuId</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@menuRole.RoleId</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@menuRole.MenuKey</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@menuRole.MenuTitle</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@menuRole.RoleName</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <form asp-action="Remove" method="post"
                                            onsubmit="return confirm('이 메뉴에서 역할을 제거하시겠습니까?');">
                                            <input type="hidden" name="menuId" value="@menuRole.MenuId" />
                                            <input type="hidden" name="roleId" value="@menuRole.RoleId" />
                                            <input type="hidden" name="returnUrl"
                                                value="@Url.Action("ByMenu", new { menuId = ViewBag.MenuId, page = ViewBag.PagingModel?.CurrentPage })" />
                                            <input type="hidden" name="returnPage" value="@ViewBag.ReturnPage" />
                                            <input type="hidden" name="returnPageSize" value="@ViewBag.ReturnPageSize" />
                                            <input type="hidden" name="returnSearchTerm" value="@ViewBag.ReturnSearchTerm" />
                                            <input type="hidden" name="returnSearchFields" value="@ViewBag.ReturnSearchFields" />
                                            <div class="flex space-x-2">
                                                <a asp-controller="Role" asp-action="Detail" asp-route-id="@menuRole.RoleId"
                                                    class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200 transition-colors">
                                                    <i class="fas fa-info-circle mr-1"></i> 역할 상세
                                                </a>
                                                <button type="submit"
                                                    class="inline-flex items-center px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors">
                                                    <i class="fas fa-trash mr-1"></i> 제거
                                                </button>
                                            </div>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- 페이징 컴포넌트 -->
                <div id="paginationContainer" class="mt-4">
                    <partial name="_Pagination" model="@ViewBag.PagingModel" />
                </div>
            }
            else
            {
                <div class="bg-blue-50 text-blue-700 p-4 rounded">
                    이 메뉴에 할당된 역할이 없습니다.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 페이징 기능 초기화
            PaginationUtils.init({
                controller: 'MenuRole',
                loadPageCallback: loadMenuRolePage
            });

            // 메뉴 역할 페이지 로드 함수
            function loadMenuRolePage(page) {
                window.location.href = '@Url.Action("ByMenu", new { menuId = ViewBag.MenuId, 
                                                                  returnPage = ViewBag.ReturnPage, 
                                                                  returnPageSize = ViewBag.ReturnPageSize, 
                                                                  returnSearchTerm = ViewBag.ReturnSearchTerm, 
                                                                  returnSearchFields = ViewBag.ReturnSearchFields })'
                    + '&page=' + page;
            }

            // 페이지 사이즈 변경 이벤트
            $('#pageSize').change(function () {
                const pageSize = $(this).val();
                window.location.href = '@Url.Action("ByMenu", new { menuId = ViewBag.MenuId, 
                                                                 page = 1, 
                                                                 returnPage = ViewBag.ReturnPage, 
                                                                 returnPageSize = ViewBag.ReturnPageSize, 
                                                                 returnSearchTerm = ViewBag.ReturnSearchTerm, 
                                                                 returnSearchFields = ViewBag.ReturnSearchFields })'
                    + '&pageSize=' + pageSize;
            });
        });
    </script>
}