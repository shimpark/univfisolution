@using UnivFI.Domain.Entities
@using System.Security.Claims
@using UnivFI.WebUI.Helpers
@inject UnivFI.Domain.Interfaces.Repositories.IMenuRepository MenuRepository
@inject UnivFI.Domain.Interfaces.Repositories.IUserRepository UserRepository
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@using System.Text.Json
@using System.Linq

@{
    // 콘텍스트에서 menuId를 가져와서 모바일인지 PC인지 구분
    var menuId = ViewData["MenuId"] as string ?? "menu";
    var isMobile = menuId == "mobileMenu";

    // 공통 스타일 및 스크립트 가져오기
    await Html.RenderPartialAsync("_UnifiedMenuStyles");

    // 메뉴 가져오기 (헬퍼 클래스 사용)
    var menus = MenuHelper.GetUserMenus(User, HttpContextAccessor, MenuRepository);

    // 메뉴 구조 생성 (헬퍼 클래스 사용)
    var menuStructure = MenuHelper.BuildMenuStructure(menus);
}

<!-- JavaScript 변수로 데이터 선언 -->
<script>
    // 메뉴 데이터를 전역 변수로 설정
    window.@(menuId)Data = @Html.Raw(Json.Serialize(menuStructure));
</script>

<div x-data="{ 
    menuItems: window.@(menuId)Data,
    currentController: window.currentController,
    ...getMenuFunctions()
}" class="@(isMobile ? "mt-2 mb-4" : "")">
    <!-- 동적 메뉴 생성 -->
    <template x-for="(menuItem, index) in menuItems" :key="index">
        <div :class="{ 'mb-1': true }">
            <div x-data="{ open: isMenuActive(menuItem) }">
                <button x-on:click="open = !open" :class="{ 
                        'flex items-center justify-between w-full px-4 py-3 text-gray-300 hover:text-white transition-colors sidebar-menu-item': true,
                        'active': isMenuActive(menuItem)
                    }">
                    <div class="flex items-center">
                        <i :class="'bi ' + (menuItem.icon || 'bi-grid') + ' mr-3'"></i>
                        <span x-text="menuItem.title"></span>
                    </div>
                    <svg class="w-4 h-4 transition-transform" :class="{ 'transform rotate-180': open }"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div x-show="open" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform -translate-y-2"
                    x-transition:enter-end="opacity-100 transform translate-y-0" class="bg-opacity-10 bg-white">
                    <template x-for="(submenu, subIndex) in menuItem.submenus" :key="subIndex">
                        <a :href="submenu.url" :class="{ 
                                'block pl-12 pr-4 py-2 text-sm text-gray-400 hover:text-white transition-colors duration-200 sidebar-menu-item': true,
                                'active': isSubmenuActive(submenu)
                            }">
                            <span x-text="submenu.title"></span>
                        </a>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <!-- 메뉴가 없을 경우 표시할 메시지 -->
    <div x-show="menuItems.length === 0"
        class="text-gray-500 text-sm px-4 py-3 @(isMobile ? "bg-gray-700 rounded-md" : "")">
        <i class="bi bi-info-circle mr-1"></i> 표시할 메뉴가 없습니다.
    </div>

    <!-- 대시보드 링크 영역 -->
    <div class="px-4 py-4 mt-6 border-t border-gray-700">
        <div class="grid grid-cols-2 gap-3">
            <a href="/Admin/Dashboard"
                class="flex flex-col items-center justify-center bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition-all duration-200 shadow-md">
                <i class="bi bi-speedometer2 text-xl mb-1"></i>
                <span class="text-xs font-medium">관리자</span>
            </a>
            <a href="/Dashboard"
                class="flex flex-col items-center justify-center bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md">
                <i class="bi bi-grid-1x2 text-xl mb-1"></i>
                <span class="text-xs font-medium">대시보드</span>
            </a>
        </div>
    </div>
</div>